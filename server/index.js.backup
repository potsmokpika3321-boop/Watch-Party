const express = require('express');
const http = require('http');
const { Server } = require('socket.io');
const { PORT } = require('./config');

const { streamVideo, getVideoInfo } = require('./videoStream');
const initSync = require('./sync');
const { startNgrok } = require('./ngrok');

const app = express();
const server = http.createServer(app);
const io = new Server(server);

// Store current video path (can be updated via admin endpoint)
let currentVideoPath = process.env.VIDEO_PATH || null;

// Middleware to parse JSON bodies
app.use(express.json());

// Serve static files
app.use(express.static(__dirname + '/../client'));

// Health check endpoint
app.get('/health', (req, res) => {
  res.status(200).json({ status: 'ok' });
});

// Admin endpoint to set video path
app.post('/admin/video-path', (req, res) => {
  const { path } = req.body;
  if (path && typeof path === 'string') {
    currentVideoPath = path;
    console.log('Video path updated:', path);
    res.json({ success: true });
  } else {
    res.status(400).json({ error: 'Invalid path' });
  }
});

// Video endpoints
app.get('/video', (req, res) => streamVideo(req, res, currentVideoPath));
app.get('/video-info', (req, res) => res.json(getVideoInfo(currentVideoPath)));

// Initialize socket synchronization
initSync(io);

// Start server
server.listen(PORT, async () => {
  console.log(`Server running on port ${PORT}`);
  
  // Start ngrok if configured
  if (process.env.NGROK_AUTHTOKEN) {
    const url = await startNgrok(PORT, process.env.NGROK_AUTHTOKEN);
    if (url) console.log(`Public URL: ${url}`);
  }
});
